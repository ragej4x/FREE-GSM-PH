{% extends 'base.html' %}
{% block content %}
  <h2>Admin Panel</h2>
  {% if error %}<div class="alert bad">{{ error }}</div>{% endif %}
  {% if success %}<div class="alert ok">{{ success }}</div>{% endif %}

  <h3>All Users</h3>
  <div class="card">
    <div class="list">
      {% for u in users %}
        <div class="list-item">
          <div style="flex:1;">
            <strong>{{ u.email }}</strong>
            {% if u.name %}<span class="hint">({{ u.name }})</span>{% endif %}
            {% if u.is_admin %}<span class="badge ok">Admin</span>{% endif %}
          </div>
          <div style="color: var(--muted);">Credits: {{ u.credits }}</div>
          <button class="btn small" data-user-id="{{ u.id }}" onclick="viewUserDetails(this.dataset.userId)">View Details</button>
        </div>
      {% else %}
        <div class="hint">No users found.</div>
      {% endfor %}
    </div>
  </div>

  <!-- User Details Modal -->
  <div id="userModal" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); z-index:1000; overflow-y:auto;">
    <div style="background: var(--bg); color: var(--primary); border:1px solid var(--muted); border-radius:8px; max-width:800px; margin:20px auto; padding:24px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h3 id="modalTitle">User Details</h3>
        <button class="btn small" onclick="closeUserModal()" style="background: var(--muted);">Close</button>
      </div>

      <div id="modalContent">
        <div class="hint">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    let currentUserId = null;

    async function viewUserDetails(userId) {
      currentUserId = parseInt(userId);
      const modal = document.getElementById('userModal');
      const content = document.getElementById('modalContent');
      modal.style.display = 'block';
      content.innerHTML = '<div class="hint">Loading...</div>';

      try {
        const res = await fetch(`/admin/user/${userId}`, { credentials: 'same-origin' });
        const data = await res.json();
        if (!res.ok) {
          content.innerHTML = `<div class="alert bad">${data.error || 'Failed to load user'}</div>`;
          return;
        }

        content.innerHTML = `
          <div class="card">
            <h4>User Information</h4>
            <label>Email
              <input type="email" id="editEmail" value="${data.email}" />
            </label>
            <label>Name
              <input type="text" id="editName" value="${data.name || ''}" placeholder="Optional" />
            </label>
            <label>API Key
              <input type="text" class="mono" value="${data.api_key}" readonly style="background: rgba(0,0,0,0.2);" />
            </label>
            <label>Created At
              <input type="text" value="${data.created_at ? new Date(data.created_at).toLocaleString() : 'N/A'}" readonly style="background: rgba(0,0,0,0.2);" />
            </label>
            <div style="margin-top:12px;">
              <button class="btn" onclick="updateUser()">Update User Info</button>
            </div>
          </div>

          <div class="card" style="margin-top:16px;">
            <h4>Credits Management</h4>
            <div style="margin-bottom:8px;">
              <strong>Current Credits: <span id="currentCredits">${data.credits}</span></strong>
            </div>
            <label>Add Credits
              <input type="number" id="addCredits" value="10" min="1" />
            </label>
            <button class="btn" onclick="modifyCredits('add')" style="margin-right:8px;">Add</button>
            <label style="margin-top:12px;">Set Credits (override)
              <input type="number" id="setCredits" value="${data.credits}" min="0" />
            </label>
            <button class="btn" onclick="modifyCredits('set')">Set</button>
            <div id="creditsStatus" class="hint" style="margin-top:8px;"></div>
          </div>

          <div class="card" style="margin-top:16px;">
            <h4>Message History (Last 50)</h4>
            <div class="list" style="max-height:300px; overflow-y:auto;">
              ${data.message_history.length === 0 
                ? '<div class="hint">No messages sent yet.</div>'
                : data.message_history.map(msg => `
                  <div class="list-item">
                    <span class="mono" style="font-size:0.85rem;">${msg.created_at ? new Date(msg.created_at).toLocaleString() : 'N/A'}</span>
                    <span class="badge ${msg.status === 'success' ? 'ok' : 'bad'}">${msg.status}</span>
                    <span>Cost: ${msg.cost}</span>
                    ${msg.details ? `<span class="hint">${msg.details}</span>` : ''}
                  </div>
                `).join('')
              }
            </div>
          </div>

          <div class="card" style="margin-top:16px; border-color: #ff6b6b;">
            <h4 style="color: #ff6b6b;">Danger Zone</h4>
            <button class="btn" onclick="deleteUser()" style="background: #ff6b6b; border-color: #ff6b6b;">Delete User</button>
            <div class="hint" style="margin-top:8px;">This action cannot be undone.</div>
          </div>
        `;
      } catch (e) {
        content.innerHTML = `<div class="alert bad">Error: ${e.message}</div>`;
      }
    }

    function closeUserModal() {
      document.getElementById('userModal').style.display = 'none';
      currentUserId = null;
    }

    async function updateUser() {
      if (!currentUserId) return;
      const email = document.getElementById('editEmail').value.trim();
      const name = document.getElementById('editName').value.trim() || null;

      try {
        const res = await fetch(`/admin/user/${currentUserId}/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ email, name })
        });
        const data = await res.json();
        if (res.ok) {
          alert('User updated successfully!');
          viewUserDetails(currentUserId); // Refresh
        } else {
          alert('Error: ' + (data.error || 'Update failed'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function modifyCredits(action) {
      if (!currentUserId) return;
      const amount = parseInt(document.getElementById(action === 'add' ? 'addCredits' : 'setCredits').value);
      if (isNaN(amount) || amount < 0) {
        document.getElementById('creditsStatus').textContent = 'Invalid amount';
        return;
      }

      try {
        const res = await fetch(`/admin/user/${currentUserId}/credits`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ action, amount })
        });
        const data = await res.json();
        if (res.ok) {
          document.getElementById('currentCredits').textContent = data.credits;
          document.getElementById('creditsStatus').textContent = data.message;
          document.getElementById('setCredits').value = data.credits;
        } else {
          document.getElementById('creditsStatus').textContent = 'Error: ' + (data.error || 'Failed');
        }
      } catch (e) {
        document.getElementById('creditsStatus').textContent = 'Error: ' + e.message;
      }
    }

    async function deleteUser() {
      if (!currentUserId) return;
      if (!confirm('Are you sure you want to delete this user? This cannot be undone.')) return;

      try {
        const res = await fetch(`/admin/user/${currentUserId}/delete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin'
        });
        const data = await res.json();
        if (res.ok) {
          alert(data.message);
          closeUserModal();
          window.location.reload(); // Refresh user list
        } else {
          alert('Error: ' + (data.error || 'Delete failed'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Close modal on outside click
    document.getElementById('userModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'userModal') closeUserModal();
    });
  </script>
{% endblock %}
